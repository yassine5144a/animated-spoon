<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Network - شبكتك الاجتماعية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #7209b7;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
        }

        .dark-mode {
            --bg-color: #1a202c;
            --card-bg: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #cbd5e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            direction: rtl;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* شاشة تسجيل الدخول */
        .auth-container {
            display: flex;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }

        .auth-box {
            background: var(--card-bg);
            margin: auto;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 450px;
            backdrop-filter: blur(10px);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-logo {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .auth-title {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-input {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .form-input.error {
            border-color: var(--danger);
        }

        .password-strength {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .strength-bar {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .strength-weak { background: var(--danger); width: 33%; }
        .strength-medium { background: var(--warning); width: 66%; }
        .strength-strong { background: var(--success); width: 100%; }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--accent);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-warning {
            background: var(--warning);
        }

        .auth-switch {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-secondary);
        }

        .auth-link {
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
        }

        .error-message {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 1rem;
            border: 1px solid rgba(247, 37, 133, 0.2);
        }

        .success-message {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 1rem;
            border: 1px solid rgba(76, 201, 240, 0.2);
        }

        /* التطبيق الرئيسي */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* الهيدر */
        .header {
            background: var(--card-bg);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header-nav {
            display: flex;
            gap: 1.5rem;
        }

        .nav-item {
            cursor: pointer;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(0,0,0,0.05);
            color: var(--text-primary);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .user-menu:hover {
            background: rgba(0,0,0,0.05);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* المحتوى الرئيسي */
        .main-content {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            gap: 2rem;
            flex: 1;
        }

        /* الشريط الجانبي */
        .sidebar {
            width: 280px;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-item:hover {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .sidebar-item.active {
            background: var(--primary);
            color: white;
        }

        /* منطقة المحتوى */
        .content-area {
            flex: 1;
        }

        .page {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .page-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .page-actions {
            display: flex;
            gap: 1rem;
        }

        /* صفحة الأصدقاء */
        .friends-page {
            min-height: 600px;
        }

        .friends-search {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .search-box {
            position: relative;
        }

        .search-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .search-input {
            width: 100%;
            padding: 1rem 3rem 1rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .friends-tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
        }

        .friend-tab {
            flex: 1;
            text-align: center;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }

        .friend-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .friends-list {
            padding: 1.5rem;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
        }

        .friend-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .friend-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
        }

        .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .friend-email {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .friend-status {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            background: var(--light);
            color: var(--text-secondary);
        }

        .friend-status.friends {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .friend-status.pending {
            background: rgba(248, 150, 30, 0.1);
            color: var(--warning);
        }

        .friend-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* التجاوب مع الشاشات الصغيرة */
        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                position: static;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .header-nav {
                gap: 0.5rem;
            }
            
            .nav-item span {
                display: none;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .friend-item {
                flex-direction: column;
                text-align: center;
            }
            
            .friend-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- سيتم تحميل التطبيق هنا -->
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged, 
            updateProfile 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            orderBy, 
            onSnapshot, 
            serverTimestamp, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            getDocs,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // تكوين Firebase الخاص بك
        const firebaseConfig = {
            apiKey: "AIzaSyC_WNvJdCRw9viU4xJfhDL_545zHK4u-kE",
            authDomain: "yassine-web-2025.firebaseapp.com",
            projectId: "yassine-web-2025",
            storageBucket: "yassine-web-2025.firebasestorage.app",
            messagingSenderId: "72261230105",
            appId: "1:72261230105:web:e056fea00afa3d8d571488",
            measurementId: "G-BG1Y78N59V"
        };

        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // جعل المتغيرات متاحة globally
        window.firebase = { app, auth, db };
        window.firebaseFunctions = { 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile,
            collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, doc, getDoc, setDoc, updateDoc, getDocs,
            arrayUnion, arrayRemove
        };
    </script>

    <script>
        class SocialApp {
            constructor() {
                this.currentUser = null;
                this.currentPage = 'home';
                this.users = {};
                this.searchResults = [];
                this.isLoading = false;
                this.friends = [];
                this.friendRequests = [];
                this.sentRequests = [];
                this.activeFriendTab = 'search';
                
                this.init();
            }

            async init() {
                console.log('Initializing SocialApp...');
                
                // التحقق من حالة المصادقة
                window.firebaseFunctions.onAuthStateChanged(window.firebase.auth, async (user) => {
                    console.log('Auth state changed:', user);
                    if (user) {
                        await this.loadUserData(user);
                        this.showApp();
                    } else {
                        this.showLogin();
                    }
                });

                // إعداد معالجات الأحداث
                this.setupEventListeners();
            }

            async loadUserData(user) {
                try {
                    console.log('Loading user data for:', user.uid);
                    const userDoc = await window.firebaseFunctions.getDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', user.uid)
                    );
                    
                    if (userDoc.exists()) {
                        this.currentUser = {
                            uid: user.uid,
                            ...userDoc.data()
                        };
                        console.log('User data loaded:', this.currentUser);
                        
                        // تحميل بيانات الأصدقاء وطلبات الصداقة
                        await this.loadFriendsData();
                    } else {
                        // إنشاء مستخدم جديد إذا لم يوجد
                        console.log('Creating new user document...');
                        await this.createUserDocument(user);
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    this.showError('خطأ في تحميل بيانات المستخدم');
                }
            }

            async createUserDocument(user) {
                try {
                    await window.firebaseFunctions.setDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', user.uid),
                        {
                            name: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            bio: 'مرحباً! أنا جديد في Social',
                            createdAt: window.firebaseFunctions.serverTimestamp(),
                            friends: [],
                            friendRequests: [],
                            sentRequests: [],
                            profilePicture: ''
                        }
                    );
                                        this.currentUser = {
                        uid: user.uid,
                        name: user.displayName || user.email.split('@')[0],
                        email: user.email,
                        bio: 'مرحباً! أنا جديد في Social',
                        friends: [],
                        friendRequests: [],
                        sentRequests: [],
                        profilePicture: ''
                    };
                    console.log('User document created:', this.currentUser);
                } catch (error) {
                    console.error('Error creating user document:', error);
                    throw error;
                }
            }

            async loadFriendsData() {
                if (!this.currentUser) return;

                try {
                    // تحميل قائمة الأصدقاء
                    const friendsPromises = this.currentUser.friends.map(async (friendId) => {
                        const friendDoc = await window.firebaseFunctions.getDoc(
                            window.firebaseFunctions.doc(window.firebase.db, 'users', friendId)
                        );
                        if (friendDoc.exists()) {
                            return { id: friendDoc.id, ...friendDoc.data() };
                        }
                        return null;
                    });

                    this.friends = (await Promise.all(friendsPromises)).filter(friend => friend !== null);

                    // تحميل طلبات الصداقة الواردة
                    const requestsPromises = this.currentUser.friendRequests.map(async (requestId) => {
                        const userDoc = await window.firebaseFunctions.getDoc(
                            window.firebaseFunctions.doc(window.firebase.db, 'users', requestId)
                        );
                        if (userDoc.exists()) {
                            return { id: userDoc.id, ...userDoc.data() };
                        }
                        return null;
                    });

                    this.friendRequests = (await Promise.all(requestsPromises)).filter(request => request !== null);

                    // تحميل طلبات الصداقة المرسلة
                    const sentPromises = this.currentUser.sentRequests.map(async (sentId) => {
                        const userDoc = await window.firebaseFunctions.getDoc(
                            window.firebaseFunctions.doc(window.firebase.db, 'users', sentId)
                        );
                        if (userDoc.exists()) {
                            return { id: userDoc.id, ...userDoc.data() };
                        }
                        return null;
                    });

                    this.sentRequests = (await Promise.all(sentPromises)).filter(sent => sent !== null);

                    console.log('Friends data loaded:', {
                        friends: this.friends,
                        requests: this.friendRequests,
                        sent: this.sentRequests
                    });

                } catch (error) {
                    console.error('Error loading friends data:', error);
                }
            }

            setupEventListeners() {
                // استخدام event delegation للتعامل مع الأحداث
                document.addEventListener('click', (e) => {
                    if (this.isLoading) return;

                    // تسجيل الدخول والتسجيل
                    if (e.target.classList.contains('auth-link')) {
                        this.toggleLoginSignup();
                    }
                    
                    if (e.target.classList.contains('login-btn')) {
                        this.handleLogin();
                    }
                    
                    if (e.target.classList.contains('signup-btn')) {
                        this.handleSignup();
                    }
                    
                    if (e.target.classList.contains('logout-btn')) {
                        this.handleLogout();
                    }

                    // التنقل
                    if (e.target.classList.contains('nav-item')) {
                        this.changePage(e.target.dataset.page);
                    }

                    if (e.target.classList.contains('sidebar-item')) {
                        this.changePage(e.target.dataset.page);
                    }

                    // الأصدقاء
                    if (e.target.classList.contains('friend-tab')) {
                        this.changeFriendTab(e.target.dataset.tab);
                    }

                    if (e.target.classList.contains('add-friend-btn')) {
                        this.sendFriendRequest(e.target.dataset.userId);
                    }

                    if (e.target.classList.contains('accept-friend-btn')) {
                        this.acceptFriendRequest(e.target.dataset.userId);
                    }

                    if (e.target.classList.contains('cancel-request-btn')) {
                        this.cancelFriendRequest(e.target.dataset.userId);
                    }

                    if (e.target.classList.contains('remove-friend-btn')) {
                        this.removeFriend(e.target.dataset.userId);
                    }
                });

                // البحث عن المستخدمين
                document.addEventListener('input', (e) => {
                    if (e.target.classList.contains('search-input')) {
                        clearTimeout(this.searchTimeout);
                        this.searchTimeout = setTimeout(() => {
                            this.searchUsers(e.target.value);
                        }, 500);
                    }
                });

                // قوة كلمة المرور
                document.addEventListener('input', (e) => {
                    if (e.target.id === 'password') {
                        this.checkPasswordStrength(e.target.value);
                    }
                });
            }

            toggleLoginSignup() {
                const loginTitle = document.getElementById('loginTitle');
                const loginBtn = document.querySelector('.login-btn');
                const signupBtn = document.querySelector('.signup-btn');
                const nameField = document.getElementById('nameField');
                const bioField = document.getElementById('bioField');

                if (loginTitle.textContent.includes('تسجيل الدخول')) {
                    loginTitle.textContent = 'إنشاء حساب جديد';
                    loginBtn.classList.add('hidden');
                    signupBtn.classList.remove('hidden');
                    nameField.classList.remove('hidden');
                    bioField.classList.remove('hidden');
                } else {
                    loginTitle.textContent = 'تسجيل الدخول';
                    loginBtn.classList.remove('hidden');
                    signupBtn.classList.add('hidden');
                    nameField.classList.add('hidden');
                    bioField.classList.add('hidden');
                }
            }

            checkPasswordStrength(password) {
                const strengthBar = document.getElementById('passwordStrength');
                if (!strengthBar) return;

                let strength = 0;
                if (password.length >= 8) strength += 1;
                if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength += 1;
                if (password.match(/\d/)) strength += 1;
                if (password.match(/[^a-zA-Z\d]/)) strength += 1;

                strengthBar.className = 'strength-bar';
                if (password.length === 0) {
                    strengthBar.style.width = '0%';
                } else if (strength === 1) {
                    strengthBar.classList.add('strength-weak');
                } else if (strength === 2 || strength === 3) {
                    strengthBar.classList.add('strength-medium');
                } else if (strength === 4) {
                    strengthBar.classList.add('strength-strong');
                }
            }

            async handleLogin() {
                if (this.isLoading) return;

                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                if (!email || !password) {
                    this.showError('يرجى ملء جميع الحقول');
                    return;
                }

                this.setLoading(true);
                
                try {
                    await window.firebaseFunctions.signInWithEmailAndPassword(
                        window.firebase.auth, email, password
                    );
                    this.showSuccess('تم تسجيل الدخول بنجاح!');
                } catch (error) {
                    console.error('Login error:', error);
                    this.showError(this.getErrorMessage(error.code));
                } finally {
                    this.setLoading(false);
                }
            }

            async handleSignup() {
                if (this.isLoading) return;

                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const bio = document.getElementById('bio').value || 'مرحباً! أنا جديد في Social';

                if (!name || !email || !password) {
                    this.showError('يرجى ملء جميع الحقول');
                    return;
                }

                if (password.length < 8) {
                    this.showError('كلمة المرور يجب أن تكون 8 أحرف على الأقل');
                    return;
                }

                this.setLoading(true);

                try {
                    // إنشاء المستخدم في Authentication
                    const result = await window.firebaseFunctions.createUserWithEmailAndPassword(
                        window.firebase.auth, email, password
                    );
                    
                    console.log('User created in auth:', result.user.uid);

                    // تحديث الاسم في Authentication
                    await window.firebaseFunctions.updateProfile(result.user, {
                        displayName: name
                    });
                    
                    console.log('Profile updated');

                    // إنشاء مستند المستخدم في Firestore
                    await this.createUserDocument(result.user);
                    
                    console.log('User document created in firestore');
                    
                    this.showSuccess('تم إنشاء الحساب بنجاح!');
                } catch (error) {
                    console.error('Signup error details:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    this.showError(this.getErrorMessage(error.code));
                } finally {
                    this.setLoading(false);
                }
            }

            getErrorMessage(errorCode) {
                const messages = {
                    'auth/email-already-in-use': 'البريد الإلكتروني مستخدم بالفعل',
                    'auth/invalid-email': 'بريد إلكتروني غير صالح',
                    'auth/weak-password': 'كلمة المرور ضعيفة (8 أحرف على الأقل)',
                    'auth/user-not-found': 'لم يتم العثور على المستخدم',
                    'auth/wrong-password': 'كلمة المرور خاطئة',
                    'auth/too-many-requests': 'محاولات كثيرة، يرجى المحاولة لاحقاً',
                    'auth/network-request-failed': 'خطأ في الاتصال بالإنترنت',
                    'auth/operation-not-allowed': 'عملية غير مسموحة',
                    'permission-denied': 'غير مصرح لك بهذا الإجراء'
                };
                return messages[errorCode] || `حدث خطأ غير متوقع: ${errorCode}`;
            }

            async handleLogout() {
                try {
                    await window.firebaseFunctions.signOut(window.firebase.auth);
                    this.showSuccess('تم تسجيل الخروج بنجاح');
                } catch (error) {
                    console.error('Error signing out:', error);
                    this.showError('خطأ في تسجيل الخروج');
                }
            }

            setLoading(loading) {
                this.isLoading = loading;
                const buttons = document.querySelectorAll('.btn');
                buttons.forEach(btn => {
                    if (loading) {
                        btn.disabled = true;
                        btn.classList.add('loading');
                    } else {
                        btn.disabled = false;
                        btn.classList.remove('loading');
                    }
                });
            }

            showLogin() {
                document.getElementById('app').innerHTML = `
                    <div class="auth-container">
                        <div class="auth-box">
                            <div class="auth-header">
                                <div class="auth-logo">
                                    <i class="fas fa-users"></i>
                                </div>
                                <h1 class="auth-title" id="loginTitle">تسجيل الدخول</h1>
                                <p class="auth-subtitle">مرحباً بعودتك! سجل الدخول إلى حسابك</p>
                            </div>
                            
                            <div id="messageContainer"></div>
                            
                            <form class="auth-form">
                                <div class="form-group hidden" id="nameField">
                                    <label class="form-label" for="name">الاسم الكامل</label>
                                    <input type="text" id="name" class="form-input" placeholder="أدخل اسمك الكامل" required>
                                </div>
                                
                                <div class="form-group hidden" id="bioField">
                                    <label class="form-label" for="bio">نبذة عنك</label>
                                    <input type="text" id="bio" class="form-input" placeholder="اكتب نبذة مختصرة عنك">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="email">البريد الإلكتروني</label>
                                    <input type="email" id="email" class="form-input" placeholder="أدخل بريدك الإلكتروني" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="password">كلمة المرور</label>
                                    <input type="password" id="password" class="form-input" placeholder="أدخل كلمة المرور" required minlength="8">
                                    <div class="password-strength">
                                        <div class="strength-bar" id="passwordStrength"></div>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn login-btn">
                                    <i class="fas fa-sign-in-alt"></i>
                                    تسجيل الدخول
                                </button>
                                <button type="button" class="btn btn-secondary signup-btn hidden">
                                    <i class="fas fa-user-plus"></i>
                                    إنشاء حساب
                                </button>
                            </form>
                            
                            <div class="auth-switch">
                                <span class="auth-link">ليس لديك حساب؟ أنشئ حساب جديد</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            showApp() {
                document.getElementById('app').innerHTML = `
                    <div class="app-container">
                        <header class="header">
                            <div class="header-logo">
                                <i class="fas fa-users"></i>
                                <span>Social</span>
                            </div>
                            
                            <nav class="header-nav">
                                <div class="nav-item ${this.currentPage === 'home' ? 'active' : ''}" data-page="home">
                                    <i class="fas fa-home"></i>
                                    <span>الرئيسية</span>
                                </div>
                                <div class="nav-item ${this.currentPage === 'friends' ? 'active' : ''}" data-page="friends">
                                    <i class="fas fa-user-friends"></i>
                                    <span>الأصدقاء</span>
                                </div>
                                <div class="nav-item ${this.currentPage === 'messages' ? 'active' : ''}" data-page="messages">
                                    <i class="fas fa-comments"></i>
                                    <span>الرسائل</span>
                                </div>
                                <div class="nav-item ${this.currentPage === 'profile' ? 'active' : ''}" data-page="profile">
                                    <i class="fas fa-user"></i>
                                    <span>الملف الشخصي</span>
                                </div>
                            </nav>
                            
                            <div class="header-actions">
                                <div class="user-menu">
                                    <div class="user-avatar">
                                        ${this.currentUser?.profilePicture ? 
                                            `<img src="${this.currentUser.profilePicture}" alt="${this.currentUser.name}">` : 
                                            this.currentUser?.name?.charAt(0) || '?'
                                        }
                                    </div>
                                    <span>${this.currentUser?.name || 'مستخدم'}</span>
                                    <button class="btn logout-btn">تسجيل الخروج</button>
                                </div>
                            </div>
                        </header>

                        <div class="main-content">
                            <aside class="sidebar">
                                <div class="sidebar-section">
                                    <h3 class="sidebar-title">
                                        <i class="fas fa-compass"></i>
                                        التنقل
                                    </h3>
                                    <div class="sidebar-item ${this.currentPage === 'home' ? 'active' : ''}" data-page="home">
                                        <i class="fas fa-home"></i>
                                        <span>الصفحة الرئيسية</span>
                                    </div>
                                    <div class="sidebar-item ${this.currentPage === 'friends' ? 'active' : ''}" data-page="friends">
                                        <i class="fas fa-user-friends"></i>
                                        <span>الأصدقاء</span>
                                    </div>
                                    <div class="sidebar-item ${this.currentPage === 'messages' ? 'active' : ''}" data-page="messages">
                                        <i class="fas fa-comments"></i>
                                        <span>الرسائل</span>
                                    </div>
                                    <div class="sidebar-item ${this.currentPage === 'profile' ? 'active' : ''}" data-page="profile">
                                        <i class="fas fa-user"></i>
                                        <span>الملف الشخصي</span>
                                    </div>
                                </div>
                                
                                <div class="sidebar-section">
                                    <h3 class="sidebar-title">
                                        <i class="fas fa-user-friends"></i>
                                        أصدقائك
                                    </h3>
                                    ${this.friends.slice(0, 5).map(friend => `
                                        <div class="sidebar-item">
                                            <div class="user-avatar" style="width: 30px; height: 30px; font-size: 0.8rem;">
                                                ${friend.profilePicture ? 
                                                    `<img src="${friend.profilePicture}" alt="${friend.name}">` : 
                                                    friend.name.charAt(0)
                                                }
                                            </div>
                                            <span>${friend.name}</span>
                                        </div>
                                    `).join('')}
                                    ${this.friends.length === 0 ? '<div style="padding: 1rem; text-align: center; color: var(--text-secondary);">لا توجد أصدقاء بعد</div>' : ''}
                                </div>
                            </aside>

                            <main class="content-area">
                                ${this.renderCurrentPage()}
                            </main>
                        </div>
                    </div>
                `;

                // تحميل البيانات الخاصة بكل صفحة
                if (this.currentPage === 'friends') {
                    this.renderFriendsPage();
                }
            }

            renderCurrentPage() {
                switch (this.currentPage) {
                    case 'home':
                        return this.renderHome();
                    case 'friends':
                        return this.renderFriendsPage();
                    case 'messages':
                        return this.renderMessages();
                    case 'profile':
                        return this.renderProfile();
                    default:
                        return this.renderHome();
                }
            }

            renderHome() {
                return `
                    <div class="page">
                        <div class="page-header">
                            <h2 class="page-title">الصفحة الرئيسية</h2>
                        </div>
                        <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-home" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h3>مرحباً بك في Social!</h3>
                            <p>هذه هي صفحتك الرئيسية. يمكنك البدء بمشاركة منشوراتك والتواصل مع أصدقائك.</p>
                        </div>
                    </div>
                `;
            }

            renderFriendsPage() {
                return `
                    <div class="page friends-page">
                        <div class="page-header">
                            <h2 class="page-title">الأصدقاء</h2>
                            <div class="page-actions">
                                <span class="friend-status">${this.friends.length} صديق</span>
                            </div>
                        </div>
                        
                        <div class="friends-search">
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="ابحث عن أصدقاء بالاسم أو البريد الإلكتروني...">
                            </div>
                        </div>
                        
                        <div class="friends-tabs">
                            <div class="friend-tab ${this.activeFriendTab === 'search' ? 'active' : ''}" data-tab="search">بحث عن أصدقاء</div>
                            <div class="friend-tab ${this.activeFriendTab === 'friends' ? 'active' : ''}" data-tab="friends">أصدقائي (${this.friends.length})</div>
                            <div class="friend-tab ${this.activeFriendTab === 'requests' ? 'active' : ''}" data-tab="requests">طلبات الصداقة (${this.friendRequests.length})</div>
                            <div class="friend-tab ${this.activeFriendTab === 'sent' ? 'active' : ''}" data-tab="sent">طلبات مرسلة (${this.sentRequests.length})</div>
                        </div>
                        
                        <div class="friends-list" id="friendsList">
                            ${this.renderFriendsContent()}
                        </div>
                    </div>
                `;
            }

            renderFriendsContent() {
                switch (this.activeFriendTab) {
                    case 'search':
                        return this.renderSearchResults();
                    case 'friends':
                        return this.renderFriendsList();
                    case 'requests':
                        return this.renderFriendRequests();
                    case 'sent':
                        return this.renderSentRequests();
                    default:
                        return this.renderSearchResults();
                }
            }
                        renderSearchResults() {
                if (this.searchResults.length === 0) {
                    return `
                        <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h3>ابحث عن أصدقاء</h3>
                            <p>اكتب اسم أو بريد إلكتروني للبحث عن أصدقاء جدد</p>
                        </div>
                    `;
                }

                return this.searchResults.map(user => {
                    const isFriend = this.friends.some(f => f.id === user.id);
                    const hasSentRequest = this.sentRequests.some(s => s.id === user.id);
                    const hasReceivedRequest = this.friendRequests.some(r => r.id === user.id);

                    let actionButton = '';
                    let status = '';

                    if (isFriend) {
                        status = '<span class="friend-status friends">أصدقاء</span>';
                        actionButton = `<button class="btn btn-outline remove-friend-btn" data-user-id="${user.id}">
                            <i class="fas fa-user-minus"></i>
                            إزالة صديق
                        </button>`;
                    } else if (hasSentRequest) {
                        status = '<span class="friend-status pending">طلب مرسل</span>';
                        actionButton = `<button class="btn btn-outline cancel-request-btn" data-user-id="${user.id}">
                            <i class="fas fa-times"></i>
                            إلغاء الطلب
                        </button>`;
                    } else if (hasReceivedRequest) {
                        status = '<span class="friend-status pending">طلب ورد</span>';
                        actionButton = `
                            <button class="btn btn-success accept-friend-btn" data-user-id="${user.id}">
                                <i class="fas fa-check"></i>
                                قبول
                            </button>
                            <button class="btn btn-outline cancel-request-btn" data-user-id="${user.id}">
                                <i class="fas fa-times"></i>
                                رفض
                            </button>
                        `;
                    } else {
                        actionButton = `<button class="btn add-friend-btn" data-user-id="${user.id}">
                            <i class="fas fa-user-plus"></i>
                            إضافة صديق
                        </button>`;
                    }

                    return `
                        <div class="friend-item">
                            <div class="friend-avatar">
                                ${user.profilePicture ? 
                                    `<img src="${user.profilePicture}" alt="${user.name}">` : 
                                    user.name.charAt(0)
                                }
                            </div>
                            <div class="friend-info">
                                <div class="friend-name">${user.name}</div>
                                <div class="friend-email">${user.email}</div>
                                ${status}
                            </div>
                            <div class="friend-actions">
                                ${actionButton}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderFriendsList() {
                if (this.friends.length === 0) {
                    return `
                        <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-user-friends" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h3>لا توجد أصدقاء بعد</h3>
                            <p>ابحث عن أصدقاء جدد وأضفهم إلى قائمة أصدقائك</p>
                        </div>
                    `;
                }

                return this.friends.map(friend => `
                    <div class="friend-item">
                        <div class="friend-avatar">
                            ${friend.profilePicture ? 
                                `<img src="${friend.profilePicture}" alt="${friend.name}">` : 
                                friend.name.charAt(0)
                            }
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${friend.name}</div>
                            <div class="friend-email">${friend.email}</div>
                            <span class="friend-status friends">أصدقاء</span>
                        </div>
                        <div class="friend-actions">
                            <button class="btn">
                                <i class="fas fa-comment"></i>
                                رسالة
                            </button>
                            <button class="btn btn-outline remove-friend-btn" data-user-id="${friend.id}">
                                <i class="fas fa-user-minus"></i>
                                إزالة
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            renderFriendRequests() {
                if (this.friendRequests.length === 0) {
                    return `
                        <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-envelope" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h3>لا توجد طلبات صداقة</h3>
                            <p>عندما يرسل لك أحدهم طلب صداقة، سيظهر هنا</p>
                        </div>
                    `;
                }

                return this.friendRequests.map(request => `
                    <div class="friend-item">
                        <div class="friend-avatar">
                            ${request.profilePicture ? 
                                `<img src="${request.profilePicture}" alt="${request.name}">` : 
                                request.name.charAt(0)
                            }
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${request.name}</div>
                            <div class="friend-email">${request.email}</div>
                            <span class="friend-status pending">طلب صداقة</span>
                        </div>
                        <div class="friend-actions">
                            <button class="btn btn-success accept-friend-btn" data-user-id="${request.id}">
                                <i class="fas fa-check"></i>
                                قبول
                            </button>
                            <button class="btn btn-outline cancel-request-btn" data-user-id="${request.id}">
                                <i class="fas fa-times"></i>
                                رفض
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            renderSentRequests() {
                if (this.sentRequests.length === 0) {
                    return `
                        <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-paper-plane" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h3>لا توجد طلبات مرسلة</h3>
                            <p>عندما ترسل طلب صداقة لأحد، سيظهر هنا</p>
                        </div>
                    `;
                }
                return this.sentRequests.map(sent => `
                    <div class="friend-item">
                        <div class="friend-avatar">
                            ${sent.profilePicture ? 
                                `<img src="${sent.profilePicture}" alt="${sent.name}">` : 
                                sent.name.charAt(0)
                            }
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${sent.name}</div>
                            <div class="friend-email">${sent.email}</div>
                            <span class="friend-status pending">في انتظار القبول</span>
                        </div>
                        <div class="friend-actions">
                            <button class="btn btn-outline cancel-request-btn" data-user-id="${sent.id}">
                                <i class="fas fa-times"></i>
                                إلغاء الطلب
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            renderMessages() {
                return `
                    <div class="page">
                        <div class="page-header">
                            <h2 class="page-title">الرسائل</h2>
                        </div>
                        <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-comments" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h3>نظام الرسائل</h3>
                            <p>هنا يمكنك الدردشة مع أصدقائك</p>
                        </div>
                    </div>
                `;
            }

            renderProfile() {
                return `
                    <div class="page">
                        <div class="page-header">
                            <h2 class="page-title">الملف الشخصي</h2>
                        </div>
                        <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                            <div class="user-avatar" style="width: 100px; height: 100px; font-size: 2.5rem; margin: 0 auto 1rem;">
                                ${this.currentUser?.profilePicture ? 
                                    `<img src="${this.currentUser.profilePicture}" alt="${this.currentUser.name}">` : 
                                    this.currentUser?.name?.charAt(0) || '?'
                                }
                            </div>
                            <h3>${this.currentUser?.name || 'مستخدم'}</h3>
                            <p>${this.currentUser?.email || ''}</p>
                            <p style="margin-top: 1rem;">${this.currentUser?.bio || 'مرحباً! أنا جديد في Social'}</p>
                            <div style="margin-top: 2rem;">
                                <div style="display: inline-block; margin: 0 1rem;">
                                    <div style="font-size: 1.5rem; font-weight: bold;">${this.friends.length}</div>
                                    <div>الأصدقاء</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            changePage(page) {
                this.currentPage = page;
                this.showApp();
            }

            changeFriendTab(tab) {
                this.activeFriendTab = tab;
                this.showApp();
            }

            async searchUsers(searchTerm) {
                if (!searchTerm || searchTerm.trim().length < 2) {
                    this.searchResults = [];
                    this.showApp();
                    return;
                }

                try {
                    this.setLoading(true);
                    
                    const usersRef = window.firebaseFunctions.collection(window.firebase.db, 'users');
                    
                    // البحث بالاسم
                    const nameQuery = window.firebaseFunctions.query(
                        usersRef,
                        window.firebaseFunctions.where('name', '>=', searchTerm),
                        window.firebaseFunctions.where('name', '<=', searchTerm + '\uf8ff')
                    );

                    // البحث بالبريد الإلكتروني
                    const emailQuery = window.firebaseFunctions.query(
                        usersRef,
                        window.firebaseFunctions.where('email', '>=', searchTerm),
                        window.firebaseFunctions.where('email', '<=', searchTerm + '\uf8ff')
                    );

                    const [nameSnapshot, emailSnapshot] = await Promise.all([
                        window.firebaseFunctions.getDocs(nameQuery),
                        window.firebaseFunctions.getDocs(emailQuery)
                    ]);

                    const usersMap = new Map();

                    // معالجة نتائج البحث بالاسم
                    nameSnapshot.forEach(doc => {
                        if (doc.id !== this.currentUser.uid) {
                            usersMap.set(doc.id, { id: doc.id, ...doc.data() });
                        }
                    });

                    // معالجة نتائج البحث بالبريد الإلكتروني
                    emailSnapshot.forEach(doc => {
                        if (doc.id !== this.currentUser.uid) {
                            usersMap.set(doc.id, { id: doc.id, ...doc.data() });
                        }
                    });

                    this.searchResults = Array.from(usersMap.values());
                    
                    console.log('Search results:', this.searchResults);
                    this.showApp();
                    
                } catch (error) {
                    console.error('Error searching users:', error);
                    this.showError('فشل في البحث عن المستخدمين');
                } finally {
                    this.setLoading(false);
                }
            }

            async sendFriendRequest(userId) {
                try {
                    this.setLoading(true);

                    // تحديث وثيقة المستخدم الحالي
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', this.currentUser.uid),
                        {
                            sentRequests: window.firebaseFunctions.arrayUnion(userId)
                        }
                    );

                    // تحديث وثيقة المستخدم الهدف
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', userId),
                        {
                            friendRequests: window.firebaseFunctions.arrayUnion(this.currentUser.uid)
                        }
                    );

                    // تحديث البيانات المحلية
                    this.currentUser.sentRequests.push(userId);
                    
                    const targetUser = this.searchResults.find(u => u.id === userId);
                    if (targetUser) {
                        this.sentRequests.push(targetUser);
                    }

                    this.showSuccess('تم إرسال طلب الصداقة بنجاح');
                    this.showApp();

                } catch (error) {
                    console.error('Error sending friend request:', error);
                    this.showError('فشل في إرسال طلب الصداقة');
                } finally {
                    this.setLoading(false);
                }
            }

            async acceptFriendRequest(userId) {
                try {
                    this.setLoading(true);

                    // إزالة من طلبات الصداقة الواردة
                                      await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', this.currentUser.uid),
                        {
                            friendRequests: window.firebaseFunctions.arrayRemove(userId),
                            friends: window.firebaseFunctions.arrayUnion(userId)
                        }
                    );

                    // إزالة من الطلبات المرسلة لدى المستخدم الآخر وإضافته كصديق
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', userId),
                        {
                            sentRequests: window.firebaseFunctions.arrayRemove(this.currentUser.uid),
                            friends: window.firebaseFunctions.arrayUnion(this.currentUser.uid)
                        }
                    );

                    // تحديث البيانات المحلية
                    this.currentUser.friendRequests = this.currentUser.friendRequests.filter(id => id !== userId);
                    this.currentUser.friends.push(userId);
                    
                    const newFriend = this.friendRequests.find(r => r.id === userId);
                    if (newFriend) {
                        this.friends.push(newFriend);
                        this.friendRequests = this.friendRequests.filter(r => r.id !== userId);
                    }

                    this.showSuccess('تمت إضافة الصديق بنجاح');
                    this.showApp();

                } catch (error) {
                    console.error('Error accepting friend request:', error);
                    this.showError('فشل في قبول طلب الصداقة');
                } finally {
                    this.setLoading(false);
                }
            }

            async cancelFriendRequest(userId) {
                try {
                    this.setLoading(true);

                    // إلغاء الطلب من المرسل
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', this.currentUser.uid),
                        {
                            sentRequests: window.firebaseFunctions.arrayRemove(userId)
                        }
                    );

                    // إلغاء الطلب من المستقبل
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', userId),
                        {
                            friendRequests: window.firebaseFunctions.arrayRemove(this.currentUser.uid)
                        }
                    );

                    // تحديث البيانات المحلية
                    this.currentUser.sentRequests = this.currentUser.sentRequests.filter(id => id !== userId);
                    this.currentUser.friendRequests = this.currentUser.friendRequests.filter(id => id !== userId);
                    
                    this.sentRequests = this.sentRequests.filter(s => s.id !== userId);
                    this.friendRequests = this.friendRequests.filter(r => r.id !== userId);

                    this.showSuccess('تم إلغاء طلب الصداقة');
                    this.showApp();

                } catch (error) {
                    console.error('Error canceling friend request:', error);
                    this.showError('فشل في إلغاء طلب الصداقة');
                } finally {
                    this.setLoading(false);
                }
            }

            async removeFriend(userId) {
                try {
                    this.setLoading(true);

                    // إزالة الصديق من المستخدم الحالي
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', this.currentUser.uid),
                        {
                            friends: window.firebaseFunctions.arrayRemove(userId)
                        }
                    );

                    // إزالة الصديق من المستخدم الآخر
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', userId),
                        {
                            friends: window.firebaseFunctions.arrayRemove(this.currentUser.uid)
                        }
                    );

                    // تحديث البيانات المحلية
                    this.currentUser.friends = this.currentUser.friends.filter(id => id !== userId);
                    this.friends = this.friends.filter(f => f.id !== userId);

                    this.showSuccess('تمت إزالة الصديق بنجاح');
                    this.showApp();

                } catch (error) {
                    console.error('Error removing friend:', error);
                    this.showError('فشل في إزالة الصديق');
                } finally {
                    this.setLoading(false);
                }
            }

            showError(message) {
                const container = document.getElementById('messageContainer');
                if (container) {
                    container.innerHTML = `<div class="error-message">${message}</div>`;
                    setTimeout(() => {
                        if (container.innerHTML.includes('error-message')) {
                            container.innerHTML = '';
                        }
                    }, 5000);
                } else {
                    alert(`خطأ: ${message}`);
                }
            }

            showSuccess(message) {
                const container = document.getElementById('messageContainer');
                if (container) {
                    container.innerHTML = `<div class="success-message">${message}</div>`;
                    setTimeout(() => {
                        if (container.innerHTML.includes('success-message')) {
                            container.innerHTML = '';
                        }
                    }, 3000);
                }
            }

            cleanup() {
                // تنظيف الاشتراكات إذا كانت موجودة
            }
        }

        // بدء التطبيق عندما يتم تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            window.socialApp = new SocialApp();
        });

        // تنظيف عند إغلاق الصفحة
        window.addEventListener('beforeunload', () => {
            if (window.socialApp) {
                window.socialApp.cleanup();
            }
        });
    </script>
</body>
</html>