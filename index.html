<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Network - شبكتك الاجتماعية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #7209b7;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            direction: rtl;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* شاشة تسجيل الدخول */
        .auth-container {
            display: flex;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }

        .auth-box {
            background: var(--card-bg);
            margin: auto;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 450px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-logo {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .auth-title {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-input {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--secondary);
        }

        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .auth-switch {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-secondary);
        }

        .auth-link {
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
        }

        .error-message {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 1rem;
            border: 1px solid rgba(247, 37, 133, 0.2);
        }

        .success-message {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 1rem;
            border: 1px solid rgba(76, 201, 240, 0.2);
        }

        .info-message {
            background: rgba(248, 150, 30, 0.1);
            color: var(--warning);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 1rem;
            border: 1px solid rgba(248, 150, 30, 0.2);
        }

        /* التطبيق الرئيسي */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* الهيدر */
        .header {
            background: var(--card-bg);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header-nav {
            display: flex;
            gap: 1.5rem;
        }

        .nav-item {
            cursor: pointer;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            position: relative;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            left: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* المحتوى الرئيسي */
        .main-content {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            gap: 2rem;
            flex: 1;
        }

        /* الشريط الجانبي */
        .sidebar {
            width: 280px;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: fit-content;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-item:hover {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .sidebar-item.active {
            background: var(--primary);
            color: white;
        }

        /* منطقة المحتوى */
        .content-area {
            flex: 1;
        }

        .page {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .page-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* صفحة المنشورات */
        .create-post {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .post-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 1rem;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .posts-feed {
            padding: 0;
        }

        .post {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .post:hover {
            background: rgba(0,0,0,0.02);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .post-author {
            font-weight: 600;
        }

        .post-time {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .post-content {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .post-actions-bar {
            display: flex;
            gap: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 8px;
        }

        .post-action:hover {
            background: rgba(0,0,0,0.05);
            color: var(--primary);
        }

        .post-action.liked {
            color: var(--danger);
        }

        .comments-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .comment {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-color);
            border-radius: 12px;
        }

        .comment-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        /* صفحة الأصدقاء */
        .friends-page {
            min-height: 600px;
        }

        .friends-search {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .search-box {
            position: relative;
        }

        .search-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .search-input {
            width: 100%;
            padding: 1rem 3rem 1rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .friends-tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
        }

        .friend-tab {
            flex: 1;
            text-align: center;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }

        .friend-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .friends-list {
            padding: 1.5rem;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
        }

        .friend-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .friend-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .friend-email {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .friend-status {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            background: var(--light);
            color: var(--text-secondary);
        }

        .friend-status.friends {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .friend-status.pending {
            background: rgba(248, 150, 30, 0.1);
            color: var(--warning);
        }

        .friend-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* الدردشة */
        .chat-container {
            display: flex;
            height: 600px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }

        .chat-sidebar {
            width: 300px;
            border-left: 1px solid #e2e8f0;
            background: var(--bg-color);
        }

        .chat-list {
            overflow-y: auto;
            height: 100%;
        }

        .chat-item {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-item:hover, .chat-item.active {
            background: white;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: var(--bg-color);
        }

        .message {
            margin-bottom: 1rem;
            max-width: 70%;
        }

        .message.own {
            margin-left: auto;
        }

        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 18px;
            background: white;
            border: 1px solid #e2e8f0;
        }

        .message.own .message-bubble {
            background: var(--primary);
            color: white;
            border: none;
        }

        .chat-input {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

        .chat-input-row {
            display: flex;
            gap: 1rem;
        }

        .chat-input-field {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            font-size: 1rem;
        }

        /* التجاوب مع الشاشات الصغيرة */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .header-nav {
                gap: 0.5rem;
            }
            
            .nav-item span {
                display: none;
            }
            
            .main-content {
                padding: 1rem;
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .friend-item {
                flex-direction: column;
                text-align: center;
            }
            
            .friend-actions {
                width: 100%;
                justify-content: center;
            }

            .chat-container {
                flex-direction: column;
                height: 500px;
            }

            .chat-sidebar {
                width: 100%;
                border-left: none;
                border-bottom: 1px solid #e2e8f0;
            }

            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- سيتم تحميل التطبيق هنا -->
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged, 
            updateProfile,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            getDocs,
            doc, 
            getDoc, 
            setDoc, 
            updateDoc,
            arrayUnion,
            arrayRemove,
            addDoc,
            deleteDoc,
            onSnapshot,
            orderBy,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // تكوين Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC_WNvJdCRw9viU4xJfhDL_545zHK4u-kE",
            authDomain: "yassine-web-2025.firebaseapp.com",
            projectId: "yassine-web-2025",
            storageBucket: "yassine-web-2025.firebasestorage.app",
            messagingSenderId: "72261230105",
            appId: "1:72261230105:web:e056fea00afa3d8d571488",
            measurementId: "G-BG1Y78N59V"
        };

        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // جعل المتغيرات متاحة globally
        window.firebase = { app, auth, db };
        window.firebaseFunctions = { 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile,
            sendPasswordResetEmail,
            collection, query, where, getDocs,
            doc, getDoc, setDoc, updateDoc,
            arrayUnion, arrayRemove,
            addDoc, deleteDoc, onSnapshot, orderBy, serverTimestamp
        };
    </script>

    <script>
        class SocialApp {
            constructor() {
                this.currentUser = null;
                this.currentPage = 'home';
                this.users = {};
                this.searchResults = [];
                this.isLoading = false;
                this.friends = [];
                this.friendRequests = [];
                this.sentRequests = [];
                this.activeFriendTab = 'search';
                this.posts = [];
                this.notifications = [];
                this.activeChat = null;
                this.messages = [];
                this.chats = [];
                
                this.init();
            }

            async init() {
                // التحقق من حالة المصادقة
                window.firebaseFunctions.onAuthStateChanged(window.firebase.auth, async (user) => {
                    if (user) {
                        await this.loadUserData(user);
                        this.showApp();
                        this.setupRealtimeListeners();
                    } else {
                        this.showLogin();
                    }
                });

                this.setupEventListeners();
            }

            async loadUserData(user) {
                try {
                    const userDoc = await window.firebaseFunctions.getDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', user.uid)
                    );
                    
                    if (userDoc.exists()) {
                        this.currentUser = {
                            uid: user.uid,
                            ...userDoc.data()
                        };
                        await this.loadFriendsData();
                        await this.loadPosts();
                        await this.loadNotifications();
                        await this.loadChats();
                    } else {
                        await this.createUserDocument(user);
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    this.showError('خطأ في تحميل بيانات المستخدم');
                }
            }

            async createUserDocument(user) {
                try {
                    await window.firebaseFunctions.setDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', user.uid),
                        {
                            name: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            bio: 'مرحباً! أنا جديد في Social',
                            createdAt: new Date(),
                            friends: [],
                            friendRequests: [],
                            sentRequests: [],
                            profilePicture: ''
                        }
                    );
                    
                    this.currentUser = {
                        uid: user.uid,
                        name: user.displayName || user.email.split('@')[0],
                        email: user.email,
                        bio: 'مرحباً! أنا جديد في Social',
                        friends: [],
                        friendRequests: [],
                        sentRequests: [],
                        profilePicture: ''
                    };
                } catch (error) {
                    console.error('Error creating user document:', error);
                    throw error;
                }
            }

            setupRealtimeListeners() {
                // الاستماع للتحديثات في الوقت الحقيقي للمنشورات
                if (this.postsUnsubscribe) this.postsUnsubscribe();
                
                const postsQuery = window.firebaseFunctions.query(
                    window.firebaseFunctions.collection(window.firebase.db, 'posts'),
                    window.firebaseFunctions.orderBy('createdAt', 'desc')
                );

                this.postsUnsubscribe = window.firebaseFunctions.onSnapshot(postsQuery, (snapshot) => {
                    this.posts = [];
                    snapshot.forEach(doc => {
                        this.posts.push({ id: doc.id, ...doc.data() });
                    });
                    if (this.currentPage === 'home') {
                        this.showApp();
                    }
                });

                // الاستماع للإشعارات
                if (this.currentUser) {
                    if (this.notificationsUnsubscribe) this.notificationsUnsubscribe();
                    
                    const notificationsQuery = window.firebaseFunctions.query(
                        window.firebaseFunctions.collection(window.firebase.db, 'notifications'),
                        window.firebaseFunctions.where('userId', '==', this.currentUser.uid),
                        window.firebaseFunctions.where('read', '==', false)
                    );

                    this.notificationsUnsubscribe = window.firebaseFunctions.onSnapshot(notificationsQuery, (snapshot) => {
                        this.notifications = [];
                        snapshot.forEach(doc => {
                            this.notifications.push({ id: doc.id, ...doc.data() });
                        });
                        this.updateNotificationBadge();
                    });

                    // الاستماع لتحديثات المحادثات
                    if (this.chatsUnsubscribe) this.chatsUnsubscribe();
                    
                    const chatsQuery = window.firebaseFunctions.query(
                        window.firebaseFunctions.collection(window.firebase.db, 'chats'),
                        window.firebaseFunctions.where('participants', 'array-contains', this.currentUser.uid),
                        window.firebaseFunctions.orderBy('lastMessageTime', 'desc')
                    );

                    this.chatsUnsubscribe = window.firebaseFunctions.onSnapshot(chatsQuery, async (snapshot) => {
                        const updatedChats = [];
                        
                        for (const doc of snapshot.docs) {
                            const chat = { id: doc.id, ...doc.data() };
                            
                            // جلب بيانات المشاركين
                            const participantsData = [];
                            for (const participantId of chat.participants) {
                                if (participantId !== this.currentUser.uid) {
                                    const userDoc = await window.firebaseFunctions.getDoc(
                                        window.firebaseFunctions.doc(window.firebase.db, 'users', participantId)
                                    );
                                    if (userDoc.exists()) {
                                        participantsData.push({ id: userDoc.id, ...userDoc.data() });
                                    }
                                }
                            }
                            
                            chat.participantsData = participantsData;
                            updatedChats.push(chat);
                        }
                        
                        this.chats = updatedChats;
                        
                        // إذا كانت صفحة الرسائل مفتوحة، قم بتحديثها
                        if (this.currentPage === 'messages') {
                            this.showApp();
                        }
                    });
                }
            }

            updateNotificationBadge() {
                const notificationElements = document.querySelectorAll('.notification-badge');
                notificationElements.forEach(element => {
                    element.textContent = this.notifications.length;
                    element.style.display = this.notifications.length > 0 ? 'flex' : 'none';
                });
            }

            async loadFriendsData() {
                if (!this.currentUser) return;

                try {
                    // تحميل الأصدقاء
                    const friendsPromises = this.currentUser.friends.map(async (friendId) => {
                        const friendDoc = await window.firebaseFunctions.getDoc(
                            window.firebaseFunctions.doc(window.firebase.db, 'users', friendId)
                        );
                        return friendDoc.exists() ? { id: friendDoc.id, ...friendDoc.data() } : null;
                    });
                    this.friends = (await Promise.all(friendsPromises)).filter(friend => friend !== null);

                    // تحميل طلبات الصداقة الواردة
                    const requestsPromises = this.currentUser.friendRequests.map(async (requestId) => {
                        const userDoc = await window.firebaseFunctions.getDoc(
                            window.firebaseFunctions.doc(window.firebase.db, 'users', requestId)
                        );
                        return userDoc.exists() ? { id: userDoc.id, ...userDoc.data() } : null;
                    });
                    this.friendRequests = (await Promise.all(requestsPromises)).filter(request => request !== null);

                    // تحميل طلبات الصداقة المرسلة
                    const sentPromises = this.currentUser.sentRequests.map(async (sentId) => {
                        const userDoc = await window.firebaseFunctions.getDoc(
                            window.firebaseFunctions.doc(window.firebase.db, 'users', sentId)
                        );
                        return userDoc.exists() ? { id: userDoc.id, ...userDoc.data() } : null;
                    });
                    this.sentRequests = (await Promise.all(sentPromises)).filter(sent => sent !== null);

                } catch (error) {
                    console.error('Error loading friends data:', error);
                }
            }

            async loadPosts() {
                try {
                    const postsQuery = window.firebaseFunctions.query(
                        window.firebaseFunctions.collection(window.firebase.db, 'posts'),
                        window.firebaseFunctions.orderBy('createdAt', 'desc')
                    );
                    
                    const querySnapshot = await window.firebaseFunctions.getDocs(postsQuery);
                    this.posts = [];
                    querySnapshot.forEach(doc => {
                        this.posts.push({ id: doc.id, ...doc.data() });
                    });
                } catch (error) {
                    console.error('Error loading posts:', error);
                }
            }

            async loadNotifications() {
                if (!this.currentUser) return;
                
                try {
                    const notificationsQuery = window.firebaseFunctions.query(
                        window.firebaseFunctions.collection(window.firebase.db, 'notifications'),
                        window.firebaseFunctions.where('userId', '==', this.currentUser.uid),
                        window.firebaseFunctions.where('read', '==', false)
                    );
                    
                    const querySnapshot = await window.firebaseFunctions.getDocs(notificationsQuery);
                    this.notifications = [];
                    querySnapshot.forEach(doc => {
                        this.notifications.push({ id: doc.id, ...doc.data() });
                    });
                    this.updateNotificationBadge();
                } catch (error) {
                    console.error('Error loading notifications:', error);
                }
            }

            async loadChats() {
                if (!this.currentUser) return;

                try {
                    const chatsQuery = window.firebaseFunctions.query(
                        window.firebaseFunctions.collection(window.firebase.db, 'chats'),
                        window.firebaseFunctions.where('participants', 'array-contains', this.currentUser.uid),
                        window.firebaseFunctions.orderBy('lastMessageTime', 'desc')
                    );

                    const querySnapshot = await window.firebaseFunctions.getDocs(chatsQuery);
                    this.chats = [];
                    
                    for (const doc of querySnapshot.docs) {
                        const chat = { id: doc.id, ...doc.data() };
                        
                        // جلب بيانات المشاركين
                        const participantsData = [];
                        for (const participantId of chat.participants) {
                            if (participantId !== this.currentUser.uid) {
                                const userDoc = await window.firebaseFunctions.getDoc(
                                    window.firebaseFunctions.doc(window.firebase.db, 'users', participantId)
                                );
                                if (userDoc.exists()) {
                                    participantsData.push({ id: userDoc.id, ...userDoc.data() });
                                }
                            }
                        }
                        
                        chat.participantsData = participantsData;
                        this.chats.push(chat);
                    }
                } catch (error) {
                    console.error('Error loading chats:', error);
                }
            }

            setupEventListeners() {
                document.addEventListener('click', (e) => {
                    if (this.isLoading) return;

                    if (e.target.classList.contains('auth-link')) {
                        if (e.target.id === 'forgotPasswordLink') {
                            this.showForgotPassword();
                        } else {
                            this.toggleLoginSignup();
                        }
                    }
                    
                    if (e.target.classList.contains('login-btn')) {
                        this.handleLogin();
                    }
                    
                    if (e.target.classList.contains('signup-btn')) {
                        this.handleSignup();
                    }
                    
                    if (e.target.classList.contains('logout-btn')) {
                        this.handleLogout();
                    }

                    if (e.target.classList.contains('nav-item')) {
                        this.changePage(e.target.dataset.page);
                    }

                    if (e.target.classList.contains('sidebar-item')) {
                        this.changePage(e.target.dataset.page);
                    }

                    if (e.target.classList.contains('friend-tab')) {
                        this.changeFriendTab(e.target.dataset.tab);
                    }

                    if (e.target.classList.contains('add-friend-btn')) {
                        this.sendFriendRequest(e.target.dataset.userId);
                    }

                    if (e.target.classList.contains('accept-friend-btn')) {
                        this.acceptFriendRequest(e.target.dataset.userId);
                    }

                    if (e.target.classList.contains('cancel-request-btn')) {
                        this.cancelFriendRequest(e.target.dataset.userId);
                    }

                    if (e.target.classList.contains('remove-friend-btn')) {
                        this.removeFriend(e.target.dataset.userId);
                    }

                    if (e.target.classList.contains('post-btn')) {
                        this.createPost();
                    }

                    if (e.target.classList.contains('like-btn')) {
                        this.toggleLike(e.target.dataset.postId);
                    }

                    if (e.target.classList.contains('comment-btn')) {
                        this.addComment(e.target.dataset.postId);
                    }

                    if (e.target.classList.contains('delete-post-btn')) {
                        this.deletePost(e.target.dataset.postId);
                    }

                    if (e.target.classList.contains('chat-item')) {
                        this.openChat(e.target.dataset.userId);
                    }

                    if (e.target.classList.contains('send-message-btn')) {
                        this.sendMessage();
                    }

                    if (e.target.classList.contains('reset-password-btn')) {
                        this.handlePasswordReset();
                    }

                    if (e.target.classList.contains('back-to-login')) {
                        this.showLogin();
                    }

                    if (e.target.classList.contains('chat-with-friend-btn')) {
                        this.openChat(e.target.dataset.userId);
                        this.currentPage = 'messages';
                        this.showApp();
                    }
                });

                document.addEventListener('input', (e) => {
                    if (e.target.classList.contains('search-input')) {
                        clearTimeout(this.searchTimeout);
                        this.searchTimeout = setTimeout(() => {
                            this.searchUsers(e.target.value);
                        }, 500);
                    }
                });

                document.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (e.target.classList.contains('comment-input')) {
                            this.addComment(e.target.dataset.postId);
                        }
                        if (e.target.classList.contains('chat-input-field')) {
                            this.sendMessage();
                        }
                    }
                });
            }

            toggleLoginSignup() {
                const loginTitle = document.getElementById('loginTitle');
                const loginBtn = document.querySelector('.login-btn');
                const signupBtn = document.querySelector('.signup-btn');
                const nameField = document.getElementById('nameField');
                const bioField = document.getElementById('bioField');

                if (loginTitle.textContent.includes('تسجيل الدخول')) {
                    loginTitle.textContent = 'إنشاء حساب جديد';
                    loginBtn.classList.add('hidden');
                    signupBtn.classList.remove('hidden');
                    nameField.classList.remove('hidden');
                    bioField.classList.remove('hidden');
                } else {
                    loginTitle.textContent = 'تسجيل الدخول';
                    loginBtn.classList.remove('hidden');
                    signupBtn.classList.add('hidden');
                    nameField.classList.add('hidden');
                    bioField.classList.add('hidden');
                }
            }

            showForgotPassword() {
                document.getElementById('app').innerHTML = `
                    <div class="auth-container">
                        <div class="auth-box">
                            <div class="auth-header">
                                <div class="auth-logo">
                                    <i class="fas fa-key"></i>
                                </div>
                                <h1 class="auth-title">استعادة كلمة المرور</h1>
                                <p class="auth-subtitle">أدخل بريدك الإلكتروني لإرسال رابط إعادة التعيين</p>
                            </div>
                            
                            <div id="messageContainer">
                                <div class="info-message">
                                    <i class="fas fa-info-circle"></i>
                                    سيرسل النظام رابطًا إلى بريدك الإلكتروني لإعادة تعيين كلمة المرور
                                </div>
                            </div>
                            
                            <form class="auth-form">
                                <div class="form-group">
                                    <label class="form-label" for="resetEmail">البريد الإلكتروني</label>
                                    <input type="email" id="resetEmail" class="form-input" placeholder="أدخل بريدك الإلكتروني المسجل" required>
                                </div>
                                
                                <button type="button" class="btn reset-password-btn">
                                    <i class="fas fa-paper-plane"></i>
                                    إرسال رابط الإعادة
                                </button>
                            </form>
                            
                            <div class="auth-switch">
                                <span class="auth-link back-to-login">العودة إلى تسجيل الدخول</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            async handlePasswordReset() {
                const email = document.getElementById('resetEmail').value;

                if (!email) {
                    this.showError('يرجى إدخال البريد الإلكتروني');
                    return;
                }

                this.setLoading(true);

                try {
                    await window.firebaseFunctions.sendPasswordResetEmail(
                        window.firebase.auth, email
                    );
                    
                    this.showSuccess(`
                        <strong>تم إرسال رابط إعادة التعيين!</strong><br>
                        يرجى التحقق من بريدك الإلكتروني (<strong>${email}</strong>)<br>
                        <small>تحقق من مجلد البريد المزعج إذا لم تجد البريد</small>
                    `);
                    
                } catch (error) {
                    this.showError(this.getErrorMessage(error.code));
                } finally {
                    this.setLoading(false);
                }
            }

            async handleLogin() {
                if (this.isLoading) return;

                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                if (!email || !password) {
                    this.showError('يرجى ملء جميع الحقول');
                    return;
                }

                this.setLoading(true);
                
                try {
                    await window.firebaseFunctions.signInWithEmailAndPassword(
                        window.firebase.auth, email, password
                    );
                    this.showSuccess('تم تسجيل الدخول بنجاح!');
                } catch (error) {
                    this.showError(this.getErrorMessage(error.code));
                } finally {
                    this.setLoading(false);
                }
            }

            async handleSignup() {
                if (this.isLoading) return;

                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const bio = document.getElementById('bio').value || 'مرحباً! أنا جديد في Social';

                if (!name || !email || !password) {
                    this.showError('يرجى ملء جميع الحقول');
                    return;
                }

                if (password.length < 8) {
                    this.showError('كلمة المرور يجب أن تكون 8 أحرف على الأقل');
                    return;
                }

                this.setLoading(true);

                try {
                    const result = await window.firebaseFunctions.createUserWithEmailAndPassword(
                        window.firebase.auth, email, password
                    );
                    
                    await window.firebaseFunctions.updateProfile(result.user, {
                        displayName: name
                    });
                    
                    await this.createUserDocument(result.user);
                    
                    this.showSuccess('تم إنشاء الحساب بنجاح!');
                } catch (error) {
                    this.showError(this.getErrorMessage(error.code));
                } finally {
                    this.setLoading(false);
                }
            }

            getErrorMessage(errorCode) {
                const messages = {
                    'auth/email-already-in-use': 'البريد الإلكتروني مستخدم بالفعل',
                    'auth/invalid-email': 'بريد إلكتروني غير صالح',
                    'auth/weak-password': 'كلمة المرور ضعيفة (8 أحرف على الأقل)',
                    'auth/user-not-found': 'لم يتم العثور على المستخدم',
                    'auth/wrong-password': 'كلمة المرور خاطئة',
                    'auth/too-many-requests': 'محاولات كثيرة، يرجى المحاولة لاحقاً',
                    'auth/user-not-found': 'لا يوجد حساب مرتبط بهذا البريد الإلكتروني'
                };
                return messages[errorCode] || `حدث خطأ غير متوقع: ${errorCode}`;
            }

            async handleLogout() {
                try {
                    // تنظيف المستمعين
                    if (this.postsUnsubscribe) this.postsUnsubscribe();
                    if (this.notificationsUnsubscribe) this.notificationsUnsubscribe();
                    if (this.chatsUnsubscribe) this.chatsUnsubscribe();
                    if (this.chatUnsubscribe) this.chatUnsubscribe();
                    
                    await window.firebaseFunctions.signOut(window.firebase.auth);
                } catch (error) {
                    console.error('Error signing out:', error);
                }
            }

            setLoading(loading) {
                this.isLoading = loading;
                const buttons = document.querySelectorAll('.btn');
                buttons.forEach(btn => {
                    btn.disabled = loading;
                    loading ? btn.classList.add('loading') : btn.classList.remove('loading');
                });
            }

            showLogin() {
                document.getElementById('app').innerHTML = `
                    <div class="auth-container">
                        <div class="auth-box">
                            <div class="auth-header">
                                <div class="auth-logo">
                                    <i class="fas fa-users"></i>
                                </div>
                                <h1 class="auth-title" id="loginTitle">تسجيل الدخول</h1>
                                <p class="auth-subtitle">مرحباً بعودتك! سجل الدخول إلى حسابك</p>
                            </div>
                            
                            <div id="messageContainer"></div>
                            
                            <form class="auth-form">
                                <div class="form-group hidden" id="nameField">
                                    <label class="form-label" for="name">الاسم الكامل</label>
                                    <input type="text" id="name" class="form-input" placeholder="أدخل اسمك الكامل" required>
                                </div>
                                
                                <div class="form-group hidden" id="bioField">
                                    <label class="form-label" for="bio">نبذة عنك</label>
                                    <input type="text" id="bio" class="form-input" placeholder="اكتب نبذة مختصرة عنك">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="email">البريد الإلكتروني</label>
                                    <input type="email" id="email" class="form-input" placeholder="أدخل بريدك الإلكتروني" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="password">كلمة المرور</label>
                                    <input type="password" id="password" class="form-input" placeholder="أدخل كلمة المرور" required minlength="8">
                                </div>
                                
                                <button type="button" class="btn login-btn">
                                    <i class="fas fa-sign-in-alt"></i>
                                    تسجيل الدخول
                                </button>
                                <button type="button" class="btn btn-secondary signup-btn hidden">
                                    <i class="fas fa-user-plus"></i>
                                    إنشاء حساب
                                </button>
                            </form>
                            
                            <div class="auth-switch">
                                <span class="auth-link">ليس لديك حساب؟ أنشئ حساب جديد</span>
                            </div>
                            <div class="auth-switch">
                                <span class="auth-link" id="forgotPasswordLink">نسيت كلمة المرور؟</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            showApp() {
                document.getElementById('app').innerHTML = `
                    <div class="app-container">
                        <header class="header">
                            <div class="header-logo">
                                <i class="fas fa-users"></i>
                                <span>Social</span>
                            </div>
                            
                            <nav class="header-nav">
                                <div class="nav-item ${this.currentPage === 'home' ? 'active' : ''}" data-page="home">
                                    <i class="fas fa-home"></i>
                                    <span>الرئيسية</span>
                                </div>
                                <div class="nav-item ${this.currentPage === 'friends' ? 'active' : ''}" data-page="friends">
                                    <i class="fas fa-user-friends"></i>
                                    <span>الأصدقاء</span>
                                    ${this.notifications.length > 0 ? `<div class="notification-badge">${this.notifications.length}</div>` : ''}
                                </div>
                                <div class="nav-item ${this.currentPage === 'messages' ? 'active' : ''}" data-page="messages">
                                    <i class="fas fa-comments"></i>
                                    <span>الرسائل</span>
                                </div>
                                <div class="nav-item ${this.currentPage === 'profile' ? 'active' : ''}" data-page="profile">
                                    <i class="fas fa-user"></i>
                                    <span>الملف الشخصي</span>
                                </div>
                            </nav>
                            
                            <div class="user-menu">
                                <div class="user-avatar">
                                    ${this.currentUser?.name?.charAt(0) || '?'}
                                </div>
                                <span>${this.currentUser?.name || 'مستخدم'}</span>
                                <button class="btn btn-outline logout-btn">تسجيل الخروج</button>
                            </div>
                        </header>

                        <div class="main-content">
                            <aside class="sidebar">
                                <div class="sidebar-section">
                                    <h3 class="sidebar-title">
                                        <i class="fas fa-compass"></i>
                                        التنقل
                                    </h3>
                                    <div class="sidebar-item ${this.currentPage === 'home' ? 'active' : ''}" data-page="home">
                                        <i class="fas fa-home"></i>
                                        <span>الصفحة الرئيسية</span>
                                    </div>
                                    <div class="sidebar-item ${this.currentPage === 'friends' ? 'active' : ''}" data-page="friends">
                                        <i class="fas fa-user-friends"></i>
                                        <span>الأصدقاء</span>
                                        ${this.notifications.length > 0 ? `<div class="notification-badge">${this.notifications.length}</div>` : ''}
                                    </div>
                                    <div class="sidebar-item ${this.currentPage === 'messages' ? 'active' : ''}" data-page="messages">
                                        <i class="fas fa-comments"></i>
                                        <span>الرسائل</span>
                                    </div>
                                    <div class="sidebar-item ${this.currentPage === 'profile' ? 'active' : ''}" data-page="profile">
                                        <i class="fas fa-user"></i>
                                        <span>الملف الشخصي</span>
                                    </div>
                                </div>
                                
                                <div class="sidebar-section">
                                    <h3 class="sidebar-title">
                                        <i class="fas fa-user-friends"></i>
                                        أصدقائك (${this.friends.length})
                                    </h3>
                                    ${this.friends.slice(0, 5).map(friend => `
                                        <div class="sidebar-item" data-user-id="${friend.id}" onclick="app.openChat('${friend.id}'); app.changePage('messages');">
                                            <div class="user-avatar" style="width: 30px; height: 30px; font-size: 0.8rem;">
                                                ${friend.name.charAt(0)}
                                            </div>
                                            <span>${friend.name}</span>
                                        </div>
                                    `).join('')}
                                    ${this.friends.length === 0 ? 
                                        '<div style="padding: 1rem; text-align: center; color: var(--text-secondary);">لا توجد أصدقاء بعد</div>' : ''}
                                </div>
                            </aside>

                            <main class="content-area">
                                ${this.renderCurrentPage()}
                            </main>
                        </div>
                    </div>
                `;

                this.updateNotificationBadge();
            }

            renderCurrentPage() {
                switch (this.currentPage) {
                    case 'home':
                        return this.renderHome();
                    case 'friends':
                        return this.renderFriendsPage();
                    case 'messages':
                        return this.renderMessages();
                    case 'profile':
                        return this.renderProfile();
                    default:
                        return this.renderHome();
                }
            }

            renderHome() {
                return `
                    <div class="page">
                        <div class="page-header">
                            <h2 class="page-title">الصفحة الرئيسية</h2>
                            <div class="user-avatar">
                                ${this.currentUser?.name?.charAt(0) || '?'}
                            </div>
                        </div>
                        
                        <div class="create-post">
                            <textarea class="post-input" placeholder="ماذا يحدث؟ شاركنا بأفكارك..."></textarea>
                            <div class="post-actions">
                                <button class="btn post-btn">
                                    <i class="fas fa-paper-plane"></i>
                                    نشر
                                </button>
                            </div>
                        </div>
                        
                        <div class="posts-feed">
                            ${this.posts.length === 0 ? `
                                <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                                    <i class="fas fa-newspaper" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                    <h3>لا توجد منشورات بعد</h3>
                                    <p>كن أول من ينشر وشاركنا بأفكارك!</p>
                                </div>
                            ` : this.posts.map(post => this.renderPost(post)).join('')}
                        </div>
                    </div>
                `;
            }

            renderPost(post) {
                const isLiked = post.likes && post.likes.includes(this.currentUser.uid);
                const isOwner = post.userId === this.currentUser.uid;
                
                return `
                    <div class="post" data-post-id="${post.id}">
                        <div class="post-header">
                            <div class="user-avatar">
                                ${post.authorName?.charAt(0) || '?'}
                            </div>
                            <div>
                                <div class="post-author">${post.authorName}</div>
                                <div class="post-time">${this.formatTime(post.createdAt?.toDate())}</div>
                            </div>
                            ${isOwner ? `
                                <button class="btn btn-danger btn-small delete-post-btn" data-post-id="${post.id}" style="margin-right: auto;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                        
                        <div class="post-content">
                            ${post.content}
                        </div>
                        
                        <div class="post-actions-bar">
                            <div class="post-action like-btn ${isLiked ? 'liked' : ''}" data-post-id="${post.id}">
                                <i class="fas fa-heart"></i>
                                <span>${post.likes?.length || 0}</span>
                            </div>
                            <div class="post-action comment-btn" data-post-id="${post.id}">
                                <i class="fas fa-comment"></i>
                                <span>${post.comments?.length || 0}</span>
                            </div>
                        </div>
                        
                        <div class="comments-section" id="comments-${post.id}">
                            ${post.comments ? post.comments.slice(0, 3).map(comment => `
                                <div class="comment">
                                    <div class="user-avatar" style="width: 35px; height: 35px; font-size: 0.8rem;">
                                        ${comment.authorName?.charAt(0) || '?'}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${comment.authorName}</div>
                                        <div>${comment.content}</div>
                                    </div>
                                </div>
                            `).join('') : ''}
                            
                            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                <input type="text" class="comment-input" data-post-id="${post.id}" placeholder="اكتب تعليقاً...">
                                <button class="btn btn-small comment-btn" data-post-id="${post.id}">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            formatTime(timestamp) {
                if (!timestamp) return 'قبل قليل';
                
                const now = new Date();
                const diff = now - timestamp;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return 'الآن';
                if (minutes < 60) return `قبل ${minutes} دقيقة`;
                if (hours < 24) return `قبل ${hours} ساعة`;
                if (days < 7) return `قبل ${days} يوم`;
                
                return timestamp.toLocaleDateString('ar-EG');
            }

            renderFriendsPage() {
                return `
                    <div class="page friends-page">
                        <div class="page-header">
                            <h2 class="page-title">الأصدقاء</h2>
                            <div class="page-actions">
                                <span class="friend-status">${this.friends.length} صديق</span>
                            </div>
                        </div>
                        
                        <div class="friends-search">
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="ابحث عن أصدقاء بالاسم أو البريد الإلكتروني...">
                            </div>
                        </div>
                        
                        <div class="friends-tabs">
                            <div class="friend-tab ${this.activeFriendTab === 'search' ? 'active' : ''}" data-tab="search">بحث عن أصدقاء</div>
                            <div class="friend-tab ${this.activeFriendTab === 'friends' ? 'active' : ''}" data-tab="friends">أصدقائي (${this.friends.length})</div>
                            <div class="friend-tab ${this.activeFriendTab === 'requests' ? 'active' : ''}" data-tab="requests">طلبات الصداقة (${this.friendRequests.length})</div>
                            <div class="friend-tab ${this.activeFriendTab === 'sent' ? 'active' : ''}" data-tab="sent">طلبات مرسلة (${this.sentRequests.length})</div>
                        </div>
                        
                        <div class="friends-list" id="friendsList">
                            ${this.renderFriendsContent()}
                        </div>
                    </div>
                `;
            }

            renderFriendsContent() {
                switch (this.activeFriendTab) {
                    case 'search':
                        return this.renderSearchResults();
                    case 'friends':
                        return this.renderFriendsList();
                    case 'requests':
                        return this.renderFriendRequests();
                    case 'sent':
                        return this.renderSentRequests();
                    default:
                        return this.renderSearchResults();
                }
            }

            renderSearchResults() {
                if (this.searchResults.length === 0) {
                    return `
                        <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h3>ابحث عن أصدقاء</h3>
                            <p>اكتب اسم أو بريد إلكتروني للبحث عن أصدقاء جدد</p>
                        </div>
                    `;
                }

                return this.searchResults.map(user => {
                    const isFriend = this.friends.some(f => f.id === user.id);
                    const hasSentRequest = this.sentRequests.some(s => s.id === user.id);
                    const hasReceivedRequest = this.friendRequests.some(r => r.id === user.id);

                    let actionButton = '';
                    let status = '';

                    if (isFriend) {
                        status = '<span class="friend-status friends">أصدقاء</span>';
                        actionButton = `
                            <button class="btn chat-with-friend-btn" data-user-id="${user.id}">
                                <i class="fas fa-comment"></i>
                                دردشة
                            </button>
                            <button class="btn btn-outline remove-friend-btn" data-user-id="${user.id}">
                                <i class="fas fa-user-minus"></i>
                                إزالة
                            </button>
                        `;
                    } else if (hasSentRequest) {
                        status = '<span class="friend-status pending">طلب مرسل</span>';
                        actionButton = `<button class="btn btn-outline cancel-request-btn" data-user-id="${user.id}">
                            <i class="fas fa-times"></i>
                            إلغاء الطلب
                        </button>`;
                    } else if (hasReceivedRequest) {
                        status = '<span class="friend-status pending">طلب ورد</span>';
                        actionButton = `
                            <button class="btn btn-success accept-friend-btn" data-user-id="${user.id}">
                                <i class="fas fa-check"></i>
                                قبول
                            </button>
                            <button class="btn btn-outline cancel-request-btn" data-user-id="${user.id}">
                                <i class="fas fa-times"></i>
                                رفض
                            </button>
                        `;
                    } else {
                        actionButton = `<button class="btn add-friend-btn" data-user-id="${user.id}">
                            <i class="fas fa-user-plus"></i>
                            إضافة صديق
                        </button>`;
                    }

                    return `
                        <div class="friend-item">
                            <div class="friend-avatar">
                                ${user.name.charAt(0)}
                            </div>
                            <div class="friend-info">
                                <div class="friend-name">${user.name}</div>
                                <div class="friend-email">${user.email}</div>
                                ${status}
                            </div>
                            <div class="friend-actions">
                                ${actionButton}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderFriendsList() {
                if (this.friends.length === 0) {
                    return `
                        <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-user-friends" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h3>لا توجد أصدقاء بعد</h3>
                            <p>ابحث عن أصدقاء جدد وأضفهم إلى قائمة أصدقائك</p>
                        </div>
                    `;
                }

                return this.friends.map(friend => `
                    <div class="friend-item">
                        <div class="friend-avatar">
                            ${friend.name.charAt(0)}
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${friend.name}</div>
                            <div class="friend-email">${friend.email}</div>
                            <span class="friend-status friends">أصدقاء</span>
                        </div>
                        <div class="friend-actions">
                            <button class="btn chat-with-friend-btn" data-user-id="${friend.id}">
                                <i class="fas fa-comment"></i>
                                دردشة
                            </button>
                            <button class="btn btn-outline remove-friend-btn" data-user-id="${friend.id}">
                                <i class="fas fa-user-minus"></i>
                                إزالة
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            renderFriendRequests() {
                if (this.friendRequests.length === 0) {
                    return `
                        <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-envelope" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h3>لا توجد طلبات صداقة</h3>
                            <p>عندما يرسل لك أحدهم طلب صداقة، سيظهر هنا</p>
                        </div>
                    `;
                }

                return this.friendRequests.map(request => `
                    <div class="friend-item">
                        <div class="friend-avatar">
                            ${request.name.charAt(0)}
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${request.name}</div>
                            <div class="friend-email">${request.email}</div>
                            <span class="friend-status pending">طلب صداقة</span>
                        </div>
                        <div class="friend-actions">
                            <button class="btn btn-success accept-friend-btn" data-user-id="${request.id}">
                                <i class="fas fa-check"></i>
                                قبول
                            </button>
                            <button class="btn btn-outline cancel-request-btn" data-user-id="${request.id}">
                                <i class="fas fa-times"></i>
                                رفض
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            renderSentRequests() {
                if (this.sentRequests.length === 0) {
                    return `
                        <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-paper-plane" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h3>لا توجد طلبات مرسلة</h3>
                            <p>عندما ترسل طلب صداقة لأحد، سيظهر هنا</p>
                        </div>
                    `;
                }

                return this.sentRequests.map(sent => `
                    <div class="friend-item">
                        <div class="friend-avatar">
                            ${sent.name.charAt(0)}
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${sent.name}</div>
                            <div class="friend-email">${sent.email}</div>
                            <span class="friend-status pending">في انتظار القبول</span>
                        </div>
                        <div class="friend-actions">
                            <button class="btn btn-outline cancel-request-btn" data-user-id="${sent.id}">
                                <i class="fas fa-times"></i>
                                إلغاء الطلب
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            renderMessages() {
                if (this.activeChat) {
                    const otherUser = this.activeChat.participantsData[0];
                    return `
                        <div class="page">
                            <div class="page-header">
                                <h2 class="page-title">الدردشة مع ${otherUser?.name || 'مستخدم'}</h2>
                                <button class="btn btn-outline" onclick="app.closeChat()">
                                    <i class="fas fa-arrow-right"></i>
                                    رجوع
                                </button>
                            </div>
                            
                            <div class="chat-container">
                                <aside class="chat-sidebar">
                                    <div class="chat-list">
                                        ${this.chats.map(chat => {
                                            const otherUser = chat.participantsData[0];
                                            const lastMessageTime = chat.lastMessageTime?.toDate ? 
                                                this.formatTime(chat.lastMessageTime.toDate()) : 'قبل قليل';
                                            
                                            return `
                                                <div class="chat-item ${chat.id === this.activeChat.id ? 'active' : ''}" 
                                                     data-user-id="${otherUser?.id}">
                                                    <div class="friend-avatar" style="width: 40px; height: 40px; font-size: 0.9rem;">
                                                        ${otherUser?.name?.charAt(0) || '?'}
                                                    </div>
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: 600;">${otherUser?.name || 'مستخدم'}</div>
                                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                                            ${chat.lastMessage || 'لا توجد رسائل'}
                                                        </div>
                                                    </div>
                                                    <div style="font-size: 0.7rem; color: var(--text-secondary);">
                                                        ${lastMessageTime}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </aside>
                                
                                <div class="chat-main">
                                    <div class="chat-header">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div class="user-avatar">
                                                ${otherUser?.name?.charAt(0) || '?'}
                                            </div>
                                            <div>
                                                <div style="font-weight: 600;">${otherUser?.name || 'مستخدم'}</div>
                                                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                                    ${otherUser?.email || ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="chat-messages" id="chatMessages">
                                        ${this.messages.map(message => `
                                            <div class="message ${message.senderId === this.currentUser.uid ? 'own' : ''}">
                                                <div class="message-bubble">
                                                    ${message.content}
                                                    <div style="font-size: 0.7rem; margin-top: 0.5rem; opacity: 0.7;">
                                                        ${this.formatTime(message.timestamp?.toDate())}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                        
                                        ${this.messages.length === 0 ? `
                                            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                                                <i class="fas fa-comment-dots" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                                <p>لا توجد رسائل بعد</p>
                                                <p>ابدأ محادثة جديدة</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="chat-input">
                                        <div class="chat-input-row">
                                            <input type="text" class="chat-input-field" placeholder="اكتب رسالتك هنا...">
                                            <button class="btn send-message-btn">
                                                <i class="fas fa-paper-plane"></i>
                                                إرسال
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="page">
                            <div class="page-header">
                                <h2 class="page-title">الرسائل</h2>
                            </div>
                            
                            <div class="chat-container">
                                <aside class="chat-sidebar">
                                    <div class="chat-list">
                                        ${this.chats.map(chat => {
                                            const otherUser = chat.participantsData[0];
                                            const lastMessageTime = chat.lastMessageTime?.toDate ? 
                                                this.formatTime(chat.lastMessageTime.toDate()) : 'قبل قليل';
                                            
                                            return `
                                                <div class="chat-item" 
                                                     data-user-id="${otherUser?.id}">
                                                    <div class="friend-avatar" style="width: 40px; height: 40px; font-size: 0.9rem;">
                                                        ${otherUser?.name?.charAt(0) || '?'}
                                                    </div>
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: 600;">${otherUser?.name || 'مستخدم'}</div>
                                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                                            ${chat.lastMessage || 'لا توجد رسائل'}
                                                        </div>
                                                    </div>
                                                    <div style="font-size: 0.7rem; color: var(--text-secondary);">
                                                        ${lastMessageTime}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                        
                                        ${this.chats.length === 0 ? `
                                            <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                                                <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                                <h3>لا توجد محادثات</h3>
                                                <p>ابدأ محادثة جديدة مع أصدقائك</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                </aside>
                                
                                <div class="chat-main">
                                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: var(--text-secondary);">
                                        <i class="fas fa-comments" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                        <h3>مرحباً في الرسائل</h3>
                                        <p>اختر محادثة من القائمة أو ابدأ محادثة جديدة مع صديق</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            renderProfile() {
                return `
                    <div class="page">
                        <div class="page-header">
                            <h2 class="page-title">الملف الشخصي</h2>
                        </div>
                        <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                            <div class="user-avatar" style="width: 100px; height: 100px; font-size: 2.5rem; margin: 0 auto 1rem;">
                                ${this.currentUser?.name?.charAt(0) || '?'}
                            </div>
                            <h3>${this.currentUser?.name || 'مستخدم'}</h3>
                            <p>${this.currentUser?.email || ''}</p>
                            <p style="margin-top: 1rem;">${this.currentUser?.bio || 'مرحباً! أنا جديد في Social'}</p>
                            <div style="margin-top: 2rem;">
                                <div style="display: inline-block; margin: 0 1rem;">
                                    <div style="font-size: 1.5rem; font-weight: bold;">${this.friends.length}</div>
                                    <div>الأصدقاء</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            changePage(page) {
                this.currentPage = page;
                this.showApp();
            }

            changeFriendTab(tab) {
                this.activeFriendTab = tab;
                this.showApp();
            }

            async searchUsers(searchTerm) {
                if (!searchTerm || searchTerm.trim().length < 2) {
                    this.searchResults = [];
                    this.showApp();
                    return;
                }

                try {
                    this.setLoading(true);
                    
                    const usersRef = window.firebaseFunctions.collection(window.firebase.db, 'users');
                    
                    // البحث بالاسم
                    const nameQuery = window.firebaseFunctions.query(
                        usersRef,
                        window.firebaseFunctions.where('name', '>=', searchTerm),
                        window.firebaseFunctions.where('name', '<=', searchTerm + '\uf8ff')
                    );

                    // البحث بالبريد الإلكتروني
                    const emailQuery = window.firebaseFunctions.query(
                        usersRef,
                        window.firebaseFunctions.where('email', '>=', searchTerm),
                        window.firebaseFunctions.where('email', '<=', searchTerm + '\uf8ff')
                    );

                    const [nameSnapshot, emailSnapshot] = await Promise.all([
                        window.firebaseFunctions.getDocs(nameQuery),
                        window.firebaseFunctions.getDocs(emailQuery)
                    ]);

                    const usersMap = new Map();

                    // معالجة نتائج البحث بالاسم
                    nameSnapshot.forEach(doc => {
                        if (doc.id !== this.currentUser.uid) {
                            usersMap.set(doc.id, { id: doc.id, ...doc.data() });
                        }
                    });

                    // معالجة نتائج البحث بالبريد الإلكتروني
                    emailSnapshot.forEach(doc => {
                        if (doc.id !== this.currentUser.uid) {
                            usersMap.set(doc.id, { id: doc.id, ...doc.data() });
                        }
                    });

                    this.searchResults = Array.from(usersMap.values());
                    this.showApp();
                    
                } catch (error) {
                    console.error('Error searching users:', error);
                    this.showError('فشل في البحث عن المستخدمين');
                } finally {
                    this.setLoading(false);
                }
            }

            async sendFriendRequest(userId) {
                try {
                    this.setLoading(true);

                    // تحديث وثيقة المستخدم الحالي - إضافة إلى sentRequests
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', this.currentUser.uid),
                        {
                            sentRequests: window.firebaseFunctions.arrayUnion(userId)
                        }
                    );

                    // تحديث وثيقة المستخدم الهدف - إضافة إلى friendRequests
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', userId),
                        {
                            friendRequests: window.firebaseFunctions.arrayUnion(this.currentUser.uid)
                        }
                    );

                    // إرسال إشعار
                    await this.sendNotification(userId, 'friend_request', `${this.currentUser.name} أرسل لك طلب صداقة`);

                    // تحديث البيانات المحلية بشكل صحيح
                    const targetUser = this.searchResults.find(u => u.id === userId);
                    if (targetUser) {
                        this.sentRequests.push(targetUser);
                        this.currentUser.sentRequests.push(userId);
                    }

                    this.showSuccess('تم إرسال طلب الصداقة بنجاح');
                    this.showApp();

                } catch (error) {
                    console.error('Error sending friend request:', error);
                    this.showError('فشل في إرسال طلب الصداقة');
                } finally {
                    this.setLoading(false);
                }
            }

            async acceptFriendRequest(userId) {
                try {
                    this.setLoading(true);

                    // إزالة من طلبات الصداقة الواردة وإضافة إلى الأصدقاء
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', this.currentUser.uid),
                        {
                            friendRequests: window.firebaseFunctions.arrayRemove(userId),
                            friends: window.firebaseFunctions.arrayUnion(userId)
                        }
                    );

                    // إزالة من الطلبات المرسلة لدى المستخدم الآخر وإضافته كصديق
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', userId),
                        {
                            sentRequests: window.firebaseFunctions.arrayRemove(this.currentUser.uid),
                            friends: window.firebaseFunctions.arrayUnion(this.currentUser.uid)
                        }
                    );

                    // إرسال إشعار
                    await this.sendNotification(userId, 'friend_accept', `${this.currentUser.name} قبل طلب صداقتك`);

                    // تحديث البيانات المحلية
                    const newFriend = this.friendRequests.find(r => r.id === userId);
                    if (newFriend) {
                        this.friends.push(newFriend);
                        this.friendRequests = this.friendRequests.filter(r => r.id !== userId);
                        this.currentUser.friendRequests = this.currentUser.friendRequests.filter(id => id !== userId);
                        this.currentUser.friends.push(userId);
                    }

                    this.showSuccess('تمت إضافة الصديق بنجاح');
                    this.showApp();

                } catch (error) {
                    console.error('Error accepting friend request:', error);
                    this.showError('فشل في قبول طلب الصداقة');
                } finally {
                    this.setLoading(false);
                }
            }

            async cancelFriendRequest(userId) {
                try {
                    this.setLoading(true);

                    // إلغاء الطلب من المرسل
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', this.currentUser.uid),
                        {
                            sentRequests: window.firebaseFunctions.arrayRemove(userId)
                        }
                    );

                    // إلغاء الطلب من المستقبل
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', userId),
                        {
                            friendRequests: window.firebaseFunctions.arrayRemove(this.currentUser.uid)
                        }
                    );

                    // تحديث البيانات المحلية
                    this.sentRequests = this.sentRequests.filter(s => s.id !== userId);
                    this.friendRequests = this.friendRequests.filter(r => r.id !== userId);
                    this.currentUser.sentRequests = this.currentUser.sentRequests.filter(id => id !== userId);
                    this.currentUser.friendRequests = this.currentUser.friendRequests.filter(id => id !== userId);

                    this.showSuccess('تم إلغاء طلب الصداقة');
                    this.showApp();

                } catch (error) {
                    console.error('Error canceling friend request:', error);
                    this.showError('فشل في إلغاء طلب الصداقة');
                } finally {
                    this.setLoading(false);
                }
            }

            async removeFriend(userId) {
                try {
                    this.setLoading(true);

                    // إزالة الصديق من المستخدم الحالي
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', this.currentUser.uid),
                        {
                            friends: window.firebaseFunctions.arrayRemove(userId)
                        }
                    );

                    // إزالة الصديق من المستخدم الآخر
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'users', userId),
                        {
                            friends: window.firebaseFunctions.arrayRemove(this.currentUser.uid)
                        }
                    );

                    // تحديث البيانات المحلية
                    this.friends = this.friends.filter(f => f.id !== userId);
                    this.currentUser.friends = this.currentUser.friends.filter(id => id !== userId);

                    this.showSuccess('تمت إزالة الصديق بنجاح');
                    this.showApp();

                } catch (error) {
                    console.error('Error removing friend:', error);
                    this.showError('فشل في إزالة الصديق');
                } finally {
                    this.setLoading(false);
                }
            }

            async createPost() {
                const postInput = document.querySelector('.post-input');
                const content = postInput.value.trim();

                if (!content) {
                    this.showError('يرجى كتابة محتوى للمنشور');
                    return;
                }

                this.setLoading(true);

                try {
                    await window.firebaseFunctions.addDoc(
                        window.firebaseFunctions.collection(window.firebase.db, 'posts'),
                        {
                            content: content,
                            userId: this.currentUser.uid,
                            authorName: this.currentUser.name,
                            likes: [],
                            comments: [],
                            createdAt: new Date()
                        }
                    );

                    postInput.value = '';
                    this.showSuccess('تم نشر المنشور بنجاح!');
                } catch (error) {
                    console.error('Error creating post:', error);
                    this.showError('فشل في نشر المنشور');
                } finally {
                    this.setLoading(false);
                }
            }

            async toggleLike(postId) {
                try {
                    const postRef = window.firebaseFunctions.doc(window.firebase.db, 'posts', postId);
                    const postDoc = await window.firebaseFunctions.getDoc(postRef);
                    
                    if (postDoc.exists()) {
                        const post = postDoc.data();
                        const likes = post.likes || [];
                        const isLiked = likes.includes(this.currentUser.uid);

                        if (isLiked) {
                            await window.firebaseFunctions.updateDoc(postRef, {
                                likes: window.firebaseFunctions.arrayRemove(this.currentUser.uid)
                            });
                        } else {
                            await window.firebaseFunctions.updateDoc(postRef, {
                                likes: window.firebaseFunctions.arrayUnion(this.currentUser.uid)
                            });

                            // إرسال إشعار إذا لم يكن المالك هو المعجب
                            if (post.userId !== this.currentUser.uid) {
                                await this.sendNotification(post.userId, 'like', `${this.currentUser.name} أعجب بمنشورك`);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error toggling like:', error);
                }
            }

            async addComment(postId) {
                const commentInput = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
                const content = commentInput.value.trim();

                if (!content) return;

                try {
                    const postRef = window.firebaseFunctions.doc(window.firebase.db, 'posts', postId);
                    const postDoc = await window.firebaseFunctions.getDoc(postRef);
                    
                    if (postDoc.exists()) {
                        const post = postDoc.data();
                        
                        await window.firebaseFunctions.updateDoc(postRef, {
                            comments: window.firebaseFunctions.arrayUnion({
                                content: content,
                                authorName: this.currentUser.name,
                                userId: this.currentUser.uid,
                                createdAt: new Date()
                            })
                        });

                        // إرسال إشعار إذا لم يكن المالك هو المعلق
                        if (post.userId !== this.currentUser.uid) {
                            await this.sendNotification(post.userId, 'comment', `${this.currentUser.name} علق على منشورك`);
                        }
                    }

                    commentInput.value = '';
                } catch (error) {
                    console.error('Error adding comment:', error);
                    this.showError('فشل في إضافة التعليق');
                }
            }

            async deletePost(postId) {
                if (!confirm('هل أنت متأكد من حذف هذا المنشور؟')) return;

                try {
                    await window.firebaseFunctions.deleteDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'posts', postId)
                    );
                    this.showSuccess('تم حذف المنشور بنجاح');
                } catch (error) {
                    console.error('Error deleting post:', error);
                    this.showError('فشل في حذف المنشور');
                }
            }

            async openChat(userId) {
                try {
                    // البحث عن محادثة موجودة أو إنشاء جديدة
                    let chat = this.chats.find(c => 
                        c.participants.includes(userId) && c.participants.includes(this.currentUser.uid)
                    );

                    if (!chat) {
                        // إنشاء محادثة جديدة
                        const chatData = {
                            participants: [this.currentUser.uid, userId],
                            createdAt: new Date(),
                            lastMessage: '',
                            lastMessageTime: new Date()
                        };

                        const chatRef = await window.firebaseFunctions.addDoc(
                            window.firebaseFunctions.collection(window.firebase.db, 'chats'),
                            chatData
                        );

                        // جلب بيانات المستخدم الآخر
                        const userDoc = await window.firebaseFunctions.getDoc(
                            window.firebaseFunctions.doc(window.firebase.db, 'users', userId)
                        );

                        chat = {
                            id: chatRef.id,
                            ...chatData,
                            participantsData: userDoc.exists() ? [{ id: userDoc.id, ...userDoc.data() }] : []
                        };

                        this.chats.push(chat);
                    }

                    this.activeChat = chat;
                    await this.loadMessages(chat.id);
                    this.setupChatListeners();
                    this.showApp();
                } catch (error) {
                    console.error('Error opening chat:', error);
                    this.showError('فشل في فتح المحادثة');
                }
            }

            async loadMessages(chatId) {
                try {
                    const messagesQuery = window.firebaseFunctions.query(
                        window.firebaseFunctions.collection(window.firebase.db, 'chats', chatId, 'messages'),
                        window.firebaseFunctions.orderBy('timestamp', 'asc')
                    );

                    const querySnapshot = await window.firebaseFunctions.getDocs(messagesQuery);
                    this.messages = [];
                    querySnapshot.forEach(doc => {
                        this.messages.push({ id: doc.id, ...doc.data() });
                    });
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }

            setupChatListeners() {
                if (this.activeChat && this.chatUnsubscribe) {
                    this.chatUnsubscribe();
                }

                if (this.activeChat) {
                    const messagesQuery = window.firebaseFunctions.query(
                        window.firebaseFunctions.collection(window.firebase.db, 'chats', this.activeChat.id, 'messages'),
                        window.firebaseFunctions.orderBy('timestamp', 'asc')
                    );

                    this.chatUnsubscribe = window.firebaseFunctions.onSnapshot(messagesQuery, (snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added') {
                                const message = { id: change.doc.id, ...change.doc.data() };
                                this.messages.push(message);
                                
                                // تحديث الواجهة إذا كانت صفحة الرسائل مفتوحة
                                if (this.currentPage === 'messages') {
                                    this.showApp();
                                }
                            }
                        });
                    });
                }
            }

            async sendMessage() {
                if (!this.activeChat) return;

                const messageInput = document.querySelector('.chat-input-field');
                const content = messageInput.value.trim();

                if (!content) return;

                try {
                    const messageData = {
                        content: content,
                        senderId: this.currentUser.uid,
                        senderName: this.currentUser.name,
                        timestamp: new Date()
                    };

                    // إضافة الرسالة
                    await window.firebaseFunctions.addDoc(
                        window.firebaseFunctions.collection(window.firebase.db, 'chats', this.activeChat.id, 'messages'),
                        messageData
                    );

                    // تحديث آخر رسالة في المحادثة
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(window.firebase.db, 'chats', this.activeChat.id),
                        {
                            lastMessage: content,
                            lastMessageTime: new Date()
                        }
                    );

                    messageInput.value = '';
                    
                } catch (error) {
                    console.error('Error sending message:', error);
                    this.showError('فشل في إرسال الرسالة');
                }
            }

            closeChat() {
                this.activeChat = null;
                this.messages = [];
                if (this.chatUnsubscribe) {
                    this.chatUnsubscribe();
                }
                this.showApp();
            }

            async sendNotification(userId, type, message) {
                try {
                    await window.firebaseFunctions.addDoc(
                        window.firebaseFunctions.collection(window.firebase.db, 'notifications'),
                        {
                            type: type,
                            userId: userId,
                            fromUserId: this.currentUser.uid,
                            fromUserName: this.currentUser.name,
                            message: message,
                            read: false,
                            createdAt: new Date()
                        }
                    );
                } catch (error) {
                    console.error('Error sending notification:', error);
                }
            }

            showError(message) {
                const container = document.getElementById('messageContainer');
                if (container) {
                    container.innerHTML = `<div class="error-message">${message}</div>`;
                    setTimeout(() => {
                        if (container.innerHTML.includes('error-message')) {
                            container.innerHTML = '';
                        }
                    }, 5000);
                } else {
                    alert(`خطأ: ${message}`);
                }
            }

            showSuccess(message) {
                const container = document.getElementById('messageContainer');
                if (container) {
                    container.innerHTML = `<div class="success-message">${message}</div>`;
                    setTimeout(() => {
                        if (container.innerHTML.includes('success-message')) {
                            container.innerHTML = '';
                        }
                    }, 5000);
                }
            }
        }

        // جعل الكائن متاحاً globally للوظائف التي تستدعي من HTML
        window.app = new SocialApp();

        // بدء التطبيق
        document.addEventListener('DOMContentLoaded', () => {
            window.app.init();
        });
    </script>
</body>
</html>